name: API and App Deploy

on:
  push:
    branches:
      - main  # Trigger workflow on push to the main branch

jobs:
  API:
    runs-on: ubuntu-latest  # Running the job on an Ubuntu runner

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Test SSH connection to Hetzner VPS (successful connection will proceed)
      - name: Test SSH Connection to Hetzner VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@178.156.135.15 "echo 'SSH connection successful'"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # Deploy API to Hetzner VPS and run build commands
      - name: Deploy and Build API on Hetzner VPS
        run: |
          # Copy files to Hetzner VPS (excluding .git and node_modules)
          rsync -avz --exclude '.git*' --exclude 'node_modules' ./api/ root@178.156.135.15:/var/www/test-folder/api

          # SSH into Hetzner and run commands to set up the API
          ssh root@178.156.135.15 << 'EOF'
            # Navigate to the API folder
            cd /var/www/test-folder/api

            # Create the dist directory
            mkdir -p dist

            # Install dependencies
            npm install

            # Build the API
            npm run build

            # Check if build was successful, then start the server
            if [ $? -eq 0 ]; then
              pm2 restart backend || pm2 start server.ts --name backend --watch
            else
              echo "Build failed, not starting the server."
              exit 1
            fi

            # Copy email templates to dist folder
            mkdir -p dist/email-templates
            cp -R ./email-templates dist/email-templates
          EOF
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

  APP:
    needs: API  # This job depends on the success of the API job
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Test SSH connection to Hetzner VPS (successful connection will proceed)
      - name: Test SSH Connection to Hetzner VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@178.156.135.15 "echo 'SSH connection successful'"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # Deploy App to Hetzner VPS and run build commands
      - name: Deploy and Build App on Hetzner VPS
        run: |
          # Copy files to Hetzner VPS (excluding .git and node_modules)
          rsync -avz --exclude '.git*' --exclude 'node_modules' ./app/ root@178.156.135.15:/var/www/test-folder/app

          # SSH into Hetzner and run commands to set up the App
          ssh root@178.156.135.15 << 'EOF'
            # Navigate to the App folder
            cd /var/www/test-folder/app

            # Create the dist directory
            mkdir -p dist

            # Install dependencies
            npm install

            # Build the App
            npm run build --verbose

          EOF
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
